C で Perl を拡張するもっとも簡単な方法

# はじめに

Perl で C の拡張を書くときにつかう XS はむずかしい、と聞いたことがあるかとおもいますが、実際んところどうなのかというと、XS は記法がむずかしかったり、なんかルールがむずかしかったりします。

また、いろんな楽をするための書き方ができて便利なのですが、そのすべてを覚えるのが面倒だったりします。

なので本稿では、こまかいところをハショって、Perl の拡張ライブラリを書く方法の基礎を一気にながしこむという形式をめざします。

Perl の世界では、C で書かれた組み込み関数を XSUB といいます。本稿では XS をつかわずに Perl の C 拡張を直接 C のマクロのみで記述することにより、学習コストの軽減をはかります。

# 型をおぼえる

Perl の内部データは構造体におさまっています。そのあたりを把握していきましょう。

継承関係にあるものは親にキャストが可能です。たとえば、AV* は SV* にキャストできます。

## SV

Perl のすべての値は SV から派生しています。

## IV

IV is-a SV の関係です。整数値がはいっています。

## NV

NV is-a SV の関係です。浮動小数点がはいっています。

## AV

AV is-a SV の関係です。配列データがはいっています。

## HV

HV is-a SV の関係です。ハッシュです。

# リファレンスカウント

Perl5 におけるメモリの管理はリファレンスカウントという方式でおこなわれています。これはつまり、変数ごとに「この変数は○箇所から参照されているョ」というマークをつけておき、どこからも参照されなくなったらその部分のメモリを再利用するというだけの仕組みです。

リファレンスカウンタ方式のメモリ管理では、このリファレンスカウンターの操作を、拡張モジュールの作者が気をつけておこなわなければなりません。

一方で、メモリの増減などが予測しやすい、デバッグがしやすいというメリットもあります。

各 Perl API の、どのタイミングでリファレンスカウントが増減するのかを把握することが、拡張モジュールを書く上での第一歩だといえます。

# C拡張の実例

## Hello, world!

まずは、もっともシンプルなケースから見ていきましょう。以下は、標準出力に "Hello, world!" という文字列を表示するだけの簡単なコードです。

XS(hello) {
dVAR; dXSVARS; # おまじない

PerlIO_printf(PerlIO_stdout(), "Hello, world!\n");

XSRETURN(0); # 返す値の数
}

まず最初に、引数の受取および返り値の返却においては、スタック構造がつかわれていることを意識してください。引数をスタックにつんだ状態で XS の関数(XSUB)はコールされます。返却値はスタックにつんでから return します。

さて、最初の XS(hello) の部分ですが、こちらは、XS 用のプロトタイプを処理するマクロです。C の関数のシグネチャーを隠蔽してくれているだけですね。

関数の中をみてみると、中には dVAR; dXSVARS; という行があります。これは、Perl の内部構造からデータをとりだすという処理を隠蔽するためのマクロです。内部構造に直接さわると、内部構造の変化によわくなるので、こういうマクロを経由してさわるのが基本です。dXSVARS; は XSUB 



# 引数の処理

# コンテキスト

GIMME_V という値を参照することで、Perl における wantarray と同等のことができます。

TODO

# 基本的な Perl API

## SV の操作

### SvREFCNT_inc(SV*)

配列のリファレンスカウントをインクリメントします。

## 配列の操作

### AV* av = newAV()

配列をつくります。リファレンスカウントはもちろん1です。

### av_push(AV*av, SV*sv)

配列に要素を push します。Perl で書いたときの `push @a, $b` とおなじです。sv のリファレンスカウントは操作されないことに気をつけてください。

### av_pop(AV*av)

配列の要素を pop します。Perl で `pop @a` とするのとおなじです。

### av_shift

### av_unshift

### av_fetch

### av_store

## HV

### 

# まとめ
XS でいろいろかいて CPAN にジャンジャンとアップしましょう。
